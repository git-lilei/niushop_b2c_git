{extend name="$base" /}
{block name="resources"}
<script type="text/javascript" src="__STATIC__/My97DatePicker/WdatePicker.js"></script>
<style type="text/css">
.set-style dl dd p{line-height: 30px;height: 30px;margin-bottom: 5px;}
.table th{font-weight: normal;}
.label-tbody label{display:inline-block;}
.addNewContent{margin-left: 10px;}
.addNewContent a:first-child{margin-right: 5px;}
.addNewContent a:last-child{margin-left: 5px;}
</style>
{/block}
{block name="main"}
<div class="set-style">
	<h4>活动信息</h4>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动名称：</dt>
		<dd>
			<input type="text" id="mansong_name" maxlength="10" value="{$mansong_info['mansong_name']}" class="input-common">
			<p class="error">请输入活动名称</p>
		</dd>
	</dl>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;生效时间：</dt>
		<dd>
			<input class="input-medium input-common harf" type="text" id="start_time" value="{$mansong_info['start_time'] | getTimeStampTurnTime}" style="width:250px;"onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<span class="mlr5">至</span> 
			<input class="input-medium input-common harf" size="15"type="text" id="end_time" value="{$mansong_info['end_time'] | getTimeStampTurnTime}" style="width:250px;"onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<p class="error">请输入生效时间</p>
		</dd>
	</dl>
	<h4>优惠设置</h4>
	<dl>
		<dt>优惠方式：</dt>
		<dd>
			<label>
				<i class="radio-common {if condition="$mansong_info['type'] eq 1"}selected{/if}">
					<input class="input-mini" type="radio" name="type" value="1" {if condition="$mansong_info['type'] eq 1"}checked="checked"{/if}> 
				</i>
				<span>普通优惠</span>
			</label>
			<label>
				<i class="radio-common {if condition="$mansong_info['type'] eq 2"}selected{/if}">
					<input class="input-mini" type="radio" name="type" value="2" {if condition="$mansong_info['type'] eq 2"}checked="checked"{/if}> 
				</i>
				<span>多级优惠</span>
			</label>
			<p class="hint">（每级优惠不累积叠加）</p>
		</dd>
	</dl>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;优惠条件：</dt>
		<dd style="width:100%;">
			<div class="table-responsive">
				<table class="table">
					<colgroup>
						<col width="10%">
						<col width="30%">
						<col width="50%">
						<col width="10%">
					</colgroup>
					<thead>
						<tr>
							<th>层级</th>
							<th>优惠门槛</th>
							<th>优惠方式（可多选）</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody class="label-tbody">
						{foreach $mansong_info['rule'] as $mansong_k => $vo }
						<tr>
							<td>{$mansong_k+1}</td>
							<td>满&nbsp;<input type="text" id="price{$mansong_k+1}" value="{$vo['price']}" style="vertical-align:middle;" class="input-common harf"><em class='unit'>元</em></td>
							<td >
								<div>
									<p>
										<label>
											<i class="checkbox-common {if condition="$vo['discount'] gt 0"}selected{/if}">
												<input type="checkbox" name="mansong" class="discount{$mansong_k+1}" onchange="setRule('discount',{$mansong_k+1},this)" {if condition="$vo['discount'] gt 0"}checked{/if}>
											</i>
											<span id="discount{$mansong_k+1}">{if condition="$vo['discount'] gt 0"}减&nbsp;<input type='text' id='discount_input{$mansong_k+1}' value="{$vo['discount']}" class="input-common harf" /><em class='unit'>元</em>{else/}&nbsp;减现金{/if}</span>
										</label>
									</p>
									<p>
										<label>
											<i class="checkbox-common {if condition="$vo['free_shipping'] eq 1"}selected{/if}">
												<input type="checkbox" name="mansong" class="free_shipping{$mansong_k+1} input-common" {if condition="$vo['free_shipping'] eq 1"}checked{/if}>
											</i>
											<span id="free_shipping{$mansong_k+1}">免邮</span>
										</label>
									</p>
									<p>
										<label>
											<i class="checkbox-common {if condition="$vo['give_point'] gt 0"}selected{/if}">
												<input type="checkbox" name="mansong" class="give_point{$mansong_k+1}" onchange="setRule('give_point',{$mansong_k+1},this)" {if condition="$vo['give_point'] gt 0"}checked{/if}>
											</i>
											<span id="give_point{$mansong_k+1}">{if condition="$vo['give_point'] gt 0"}送&nbsp;<input type='text' id='give_point_input{$mansong_k+1}' value="{$vo['give_point']}" class="input-common harf"/><em class='unit'>积分</em>{else/}&nbsp;送积分{/if}</span>
										</label>
									</p>
									<p>
										<label>
											<i class="checkbox-common {if condition="$vo['give_coupon'] gt 0"}selected{/if}">
												<input type="checkbox" name="mansong" class="give_coupon{$mansong_k+1}" onchange="setRule('give_coupon',{$mansong_k+1},this)" {if condition="$vo['give_coupon'] gt 0"}checked{/if} data-type="coupon">
											</i>
											<span id="give_coupon{$mansong_k+1}">
												{if condition="$vo['give_coupon'] gt 0"}送&nbsp;
													<select id="give_coupon_select{$mansong_k+1}" class="select-common">
														{volist name="coupon_type_list['data']" id="vc" key="k"}
															<option value="{$vc['coupon_type_id']}" {if condition="$vo['give_coupon'] eq $vc['coupon_type_id']"}selected{/if}>
																{$vc['coupon_name']}
															</option>
														{/volist}
													</select>
												{else/}
													送优惠券
												{/if}
											</span>
										</label>
									</p>
									<p>
										<label>
											<i class="checkbox-common {if condition="$vo['gift_id'] gt 0"}selected{/if}">
												<input type="checkbox" name="mansong" class="gift_id{$mansong_k+1}" onchange="setRule('gift_id',{$mansong_k+1},this)" {if condition="$vo['gift_id'] gt 0"}checked{/if} data-type="gift">
											</i>
											<span id="gift_id{$mansong_k+1}">{if condition="$vo['gift_id'] gt 0"}送&nbsp;<select id="gift_id_select{$mansong_k+1}" class="select-common">{volist name="gift_list['data']" id="vc"}<option value="{$vc['gift_id']}" {if condition="$vo['gift_id'] eq $vc['gift_id']"}selected{/if}>{$vc['gift_name']}</option>{/volist}</select>{else/}送赠品{/if}</span>
										</label>
									</p>
								</div>
							</td>
							<td>{if condition="$mansong_k+1 > 1"}<a href="javascript:void(0);" onclick="delCengji({$mansong_k+1})">删除</a>{/if}</td>
						</tr>
						{/foreach}
					</tbody>
					<tfoot {if condition="$mansong_info['type'] eq 1"} style="display:none;" {/if}>
						<tr>
							<td colspan="4">
								<a href="javascript:void(0)" onclick="addReward()">+新增一级优惠</a>
								<span class="gray pl20">最多可设置五个层级</span>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>
		</dd>
	</dl>
	<h4>选择活动商品</h4>
	<!-- ******************************************* start 选择商品 start ******************************************* -->
	<!-- 
		is_limit_sku 是否限制只查询单规格商品 1限制 0不限制
		is_many_select 是否可多选 1可多选 0只能单选
		is_limit_skock 是否只查询有库存的商品 1只查询有库存商品 0不限制
		is_limit_state 是否只查询已上架商品 1只查询上架商品 0不限制
		is_limit_goods_type 是否限制只查询实物商品 1限制 0不限制
	 -->
	<input type="hidden" id="range_type" value="{$mansong_info.range_type}">
	<input type="hidden" id="is_show_select" value="1">
	<input type="hidden" id="goods_id_array" value="{$mansong_info.goods_id_array}">
	<input type="hidden" id="select-goods-limit" value='{"is_limit_sku" : 0, "is_many_select" : 1, "is_limit_skock" : 1, "is_limit_state" : 1, "is_limit_goods_type" : 0}'>
	{include file="admin/Promotion/goodsSelectDialog"/}
	<!-- ******************************************* end 选择商品 end ******************************************* -->
	<dl>
		<dt></dt>
		<dd>
			<button class="btn-common btn-big" onclick="updateMansong();">保存</button>
			<button class="btn-common-cancle btn-big" onclick="javascript:history.back(-1);">返回</button>
		</dd>
	</dl>
</div>
<input type="hidden" id="mansong_id" value="{$mansong_info['mansong_id']}"/>
<script>
//保存
var flag = false;//防止重复提交
function updateMansong(){
	var mansong_id = $("#mansong_id").val();
	var mansong_name = $("#mansong_name").val();
	var start_time = $("#start_time").val();
	var end_time = $("#end_time").val();
	var type = $("input[type='radio'][name='type']:checked").val();
	var range_type = $("input[type='radio'][name='range_type']:checked").val();
	var rule = '';
	var obj = $(".table tbody tr");
	if(!verify(mansong_name, start_time, end_time)){
		return false;
	}
	for(var i=1;i<=obj.length;i++){
		//满减送价格
		if($("#price"+i).val() > 0){
			var price = $("#price"+i).val();
		}else{
			var price = 0;
			showMessage('error', '请输入优惠门槛金额');
			return false;
		}
		//减现金
		if($("input.discount"+i+"[type='checkbox']").is(':checked') == true){
			var discount = $("#discount_input"+i+"").val();
		}else{
			var discount = 0;
		}
		//免邮
		if($("input.free_shipping"+i+"[type='checkbox']").is(':checked') == true){
			var free_shipping = 1;
		}else{
			var free_shipping = 0;
		}
		//送积分
		if($("input.give_point"+i+"[type='checkbox']").is(':checked') == true){
			var give_point = $("#give_point_input"+i).val();
		}else{
			var give_point = 0;
		}
		//送优惠券
		if($("input.give_coupon"+i+"[type='checkbox']").is(':checked') == true){
			var give_coupon = $("#give_coupon_select"+i).val();
		}else{
			var give_coupon = 0;
		}
		//送赠品
		 if($("input.gift_id"+i+"[type='checkbox']").is(':checked') == true){
			var gift_id = $("#gift_id_select"+i).val();
		}else{ 
			var gift_id = 0;
		 } 
		if(discount+free_shipping+give_point+give_coupon+gift_id == 0){
			showMessage('error', '请至少选择一种优惠方式');
			return false;
		}
		rule += ';'+price+','+discount+','+free_shipping+','+give_point+','+give_coupon+','+gift_id;
	}
	rule = rule.substring(1);
	
	var obj = $(".select-two table tbody tr");
	
	var goods_id_array = $("#goods_id_array").val();
	if(range_type == 0 && BatchSend.length == 0){
		$(".js-select-goods").find(".error").html('请选择参加活动的商品').show();
		//showMessage('error', '请选择参加活动的商品');
		return false;
	}else{
		$(".error").hide();
	}
		if(flag){
			return;
		}
		flag = true;
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/promotion/updatemansong')}",
			data : {
				'mansong_id' : mansong_id,
				'mansong_name' : mansong_name,
				'start_time' : start_time,
				'end_time' : end_time,
				'type' : type,
				'range_type' : range_type,
				'rule' : rule,
				'goods_id_array' : goods_id_array
			},
			success : function(data) {
				if (data["code"] > 0) {
					showMessage('success', data["message"],"{:__URL('ADMIN_MAIN/promotion/mansonglist')}");
				}else{
					showMessage('error', data["message"]);
					flag = false;
				}
			}
		});
}

//模块输入信息验证
function verify(mansong_name, start_time, end_time){
	if(mansong_name == ''){
		$("#mansong_name").parent().find('.error').show();
		return false;
	}else{
		$(".error").hide();
	}
	if(start_time == '' || end_time == ''){
		$("#start_time").parent().find('.error').show();
		return false;
	}else{
		$(".error").hide();
	}
	return true;
}

//控制商品列表显示数据
function ShopRadio(num){
	if(num == 0){
		$("#some_pro").show();
	}else if(num == 1){
		$("#some_pro").hide();
		$("#DiscountList").hide();
		$("#goodsCountList tr").remove();
		$("#condition").val("");
		$goodsArr = new Array();
	}
}

//添加一级优惠
function addReward(){
	var len = $(".table tbody tr").length;
	if(len >= 5){
		$(".table tfoot").hide();
	}else{
		var cengji =  Number(len)+1;
		var html = '';
		html += '<tr>';
		html += '<td>'+cengji+'</td>';
		html += '<td>满&nbsp;<input type="number" id="price'+cengji+'" class="input-common harf" style="width:50px;vertical-align:middle;"><em class="unit">元</</em></td>';
		html += '<td><div>';
		html += '<p><label><i class="checkbox-common"><input type="checkbox" name="mansong" class="discount'+cengji+'" onchange="setRule(\'discount\','+cengji+',this)"></i><span id="discount'+cengji+'">减现金</span></label></p>';
		html += '<p><label><i class="checkbox-common"><input type="checkbox" name="mansong" class="free_shipping'+cengji+'"></i><span id="free_shipping'+cengji+'">免邮</span></label></p>';
		html += '<p><label><i class="checkbox-common"><input type="checkbox" name="mansong" class="give_point'+cengji+'" onchange="setRule(\'give_point\','+cengji+',this)"></i><span id="give_point'+cengji+'">送积分</span></label></p>';
		html += '<p><label><i class="checkbox-common"><input type="checkbox" name="mansong" data-type="coupon" class="give_coupon'+cengji+'" onchange="setRule(\'give_coupon\','+cengji+',this)"></i><span id="give_coupon'+cengji+'">送优惠券</span></label></p>';
		html += '<p><label><i class="checkbox-common"><input type="checkbox" name="mansong" data-type="gift" class="gift_id'+cengji+'" onchange="setRule(\'gift_id\','+cengji+',this)"></i><span id="gift_id'+cengji+'">送赠品</span></label></p>';
		html += '</div></td>';
		html += '<td style="text-align:center;"><a href="javascript:void(0);" onclick="delCengji('+cengji+')">删除</a></td>';
		html += '</tr>';
		$(".table tbody").append(html);
		if(cengji == 5){
			$(".table tfoot").hide();
		}
	}
}
//删除层级
function delCengji(cengji){
	$(".table tbody tr:last").remove();
}

$("input[name='type']").change(function(){
	var c = $(this).val();
	if(c == 2){
		$(".table tfoot").show();
	}else{
		$(".table tbody tr:gt(0)").remove();
		$(".table tfoot").hide();
	}
});

//优惠类型点击
function setRule(type,num,e){
	if(type == 'discount'){
		discount(num,e);
	}else if(type == 'give_point'){
		givePoint(num,e);
	}else if(type == 'give_coupon'){
		giveCoupon(num,e);
	}else if(type == 'gift_id'){
		giftSelect(num,e);
	}
}

//减现金
function discount(num,e){
	if(e.checked == true){
		var html = "减&nbsp;<input type='text' id='discount_input"+num+"' style='width:50px;vertical-align:middle;' class='input-common harf'/><em class='unit'>元</em>";
	}else{
		var html = "减现金";
	}
	$("#discount"+num).html(html);
}

//送积分
function givePoint(num,e){
	if(e.checked == true){
		var html = "送&nbsp;<input type='text' id='give_point_input"+num+"' style='width:50px;vertical-align:middle;' class='input-common harf' /><em class=\"unit\">分</em>";
	}else{
		var html = "送积分";
	}
	$("#give_point"+num).html(html);
}

//送优惠券
function giveCoupon(num,e){
	if(e.checked == true){
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/promotion/coupontypelist')}",
			success : function(data) {
				var html = '送&nbsp;<select id="give_coupon_select'+num+'" class="select-common">';
				if(data['data'].length > 0){
					for(var i=0;i<data['data'].length;i++){
						html += '<option value="'+data['data'][i]['coupon_type_id']+'">'+data['data'][i]['coupon_name']+'</option>';
					}
				}else{
					html += '<option value="0">您还未创建优惠券</option>';
				}
				html += "</select>";
				html += '<span class="addNewContent"><a href="javascript:;" class="refresh">刷新</a>|<a href="{:__URL("ADMIN_MAIN/promotion/addcoupontype")}" target="_blank">创建</a></span>';
				$("#give_coupon"+num).html(html);
				$('.select-common').selectric();
			}
		});
	}else{
		var html = "送优惠券";
		$("#give_coupon"+num).html(html);
	}
}

//送赠品
function giftSelect(num,e){
	if(e.checked == true){
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/promotion/gift')}",
			data : {"type" : 1, "is_virtual" : 0},
			success : function(data) {
				var html = '送&nbsp;<select id="gift_id_select'+num+'" class="select-common">';
				if(data.length > 0){
					for(var i=0;i<data.length;i++){
						html += '<option value="'+data[i]['gift_id']+'">'+data[i]['gift_name']+'</option>';
					}
				}else{
					html += '<option value="0">您还未创建赠品</option>';
				}
				html += "</select>";
				html += '<span class="addNewContent"><a href="javascript:;" class="refresh">刷新</a>|<a href="{:__URL("ADMIN_MAIN/promotion/addgift")}" target="_blank">创建</a></span>';
				$("#gift_id"+num).html(html);
				$('.select-common').selectric();
			}
		});
	}else{
		var html = "送赠品";
		$("#gift_id"+num).html(html);
	}
}

$(".addNewContent .refresh").live("click", function(){
	var checkbox_obj = $(this).parents("p").find('input[type="checkbox"]');
	if($(checkbox_obj).attr("data-type") == "gift"){
		checkbox_obj.prop({"checked" : false}).click().parent().addClass('selected');
	}else if($(checkbox_obj).attr("data-type") == "coupon"){
		checkbox_obj.prop({"checked" : false}).click().parent().addClass('selected');
	}
})
</script>
{/block}